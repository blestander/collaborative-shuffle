<html>
    <head>
        <title>Spotify Collaborative Shuffle</title>
        <style>
            div#pre_auth {
                display:block
            }
            div {
                display:none
            }
        </style>
        <script>
            const CLIENT_ID = "5ac550d329b64aba9bea1ee3a2dd3969";
            const SCOPE = "playlist-read-collaborative";
            var token;

            function initialLoad() {
                var url = window.location.href; // Obtains page url
                var hashFragment = url.match(/\#.*$/); // Parses out hash fragment
                if (hashFragment == null) { // No hash fragment; need to to authorization
                    var authURL = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${url}&scope=${SCOPE}`;
                    document.getElementById("auth_link").href = authURL;
                } else { // Hash fragment present; proceed onward
                    var queryString = hashFragment[0].replace("#", "?") // Convert hash fragment to query string

                    document.getElementById("pre_auth").style.display = "none"; // Hide pre-authorization screen

                    // Convert query string into searchable form
                    var query = new URLSearchParams(queryString);

                    if (query.has("access_token")) { // Authorization success
                        document.getElementById("post_auth").style.display = "block"; // Make post-auth screen visible
                        token = query.get("access_token"); // Store token for future use

                        // Request list of playlists from Spotify
                        var request = new XMLHttpRequest();
                        request.open("GET", "https://api.spotify.com/v1/me/playlists/");
                        request.onreadstatechange = displayPlaylists(request);
                        request.setRequestHeader("Authorization", `Bearer ${token}`)
                        request.send();
                    } else { // Authorization failure
                        document.getElementById("failed_auth").style.display = "block"; // Make failure screen visible
                        document.getElementById("error").innerText = query.get("error")
                    }
                }
            }
        
            function displayPlaylists(request) {
                return function() {
                    document.getElementById("post_auth").style.display = "none"; // Hide post-auth screen
                    document.getElementById("playlist_select").style.display = "none"; // Show playlist select screen
                };
            }
        </script>
    </head>
    <body onload=initialLoad()>
        <div id="pre_auth">
            <p><a id="auth_link">Hello, world!</a></p>
        </div>
        <div id="post_auth">
            <p>Authorization successful!<br />Loading playlists...</p>
        </div>
        <div id="playlist_select">
            <p>Playlists loaded</p>
        </div>
        <div id="failed_auth">
            <p>Authorization failed!</p>
            <p>Error: <span id="error"></span></p>
        </div>
    </body>
</html>