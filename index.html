<!DOCTYPE html>
<html>
    <head>
        <title>Spotify Collaborative Shuffle</title>
        <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <style>
            body {
                background-color: #1DB954;
            }
            div#main {
                display: table;
                background-color: #FFFFFF;
                color: #000000;
                font-family: Montserrat, san-serif;
                text-align: center;
                position: absolute;
                width: 60%;
                left: 20%;
            }
            div#pre_auth {
                display:block
            }
            div {
                display:none
            }
        </style>
        <script>
            const CLIENT_ID = "5ac550d329b64aba9bea1ee3a2dd3969";
            const SCOPE = "playlist-read-collaborative playlist-read-private user-modify-playback-state";
            var token;

            // Adding authorization header to each AJAX request
            $(document).ajaxSend(function(event, request, options) {
                request.setRequestHeader("Authorization", `Bearer ${token}`)
            });

            function Song(id, name, artist, uri) {
                this.id = id;
                this.name = name;
                this.artist = artist;
                this.uri = uri;
            }

            function initialLoad() {
                var url = window.location.href; // Obtains page url
                var hashFragment = url.match(/\#.*$/); // Parses out hash fragment
                if (hashFragment == null) { // No hash fragment; need to to authorization
                    var authURL = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${url}&scope=${SCOPE}`;
                    $("#auth_link").attr("href", authURL);
                } else { // Hash fragment present; proceed onward
                    var queryString = hashFragment[0].replace("#", "?") // Convert hash fragment to query string

                    $("#pre_auth").hide(); // Hide pre-authorization screen

                    // Convert query string into searchable form
                    var query = new URLSearchParams(queryString);

                    if (query.has("access_token")) { // Authorization success
                        $("#post_auth").show(); // Make post-auth screen visible
                        token = query.get("access_token"); // Store token for future use

                        // Request list of playlists from Spotify
                        $.get(
                            "https://api.spotify.com/v1/me/playlists/",
                            null,
                            displayPlaylists,
                        );
                    } else { // Authorization failure
                        $("#failed_auth").show(); // Make failure screen visible
                        $("#error").text(query.get("error"));
                    }
                }
            }
        
            function displayPlaylists(response, status) {
                if (status == "success") { // Response is OK or cached
                    $("#post_auth").hide(); // Hide post-auth screen
                    $("#playlist_screen").show(); // Show playlist select screen

                    var selector = $("#playlist_select"); // Obtain playlist dropdown.
                    var playlists = response.items; // Obtain list of playlists from response
                    // For each playlist, create an option in the drop down.
                    playlists.forEach(function(playlist, index) {
                        var option = $("<option></option>")
                            .attr("value", playlist.id)
                            .text(playlist.name);
                        selector.append(option);
                    });

                    // If there are more playlists, obtain them.
                    if (response.next != null) {
                        $.get(response.next, null, displayPlaylists);
                    }
                }
            }

            function startShuffleAndQueue() {
                // Obtain selected playlist ID
                var id = $("#playlist_select option:selected").attr("value");
                
                // Retrieve songs
                var request = new XMLHttpRequest();
                $.get(
                    `https://api.spotify.com/v1/playlists/${id}`,
                    null,
                    extractPlaylistSongs
                );
            }

            function extractPlaylistSongs(response, status) {
                if (status == "success") { // If response is OK or cached
                    var songs = new Array();
                    continueExtractingPlaylistSongs(songs, response.tracks);
                }
            }

            function continueExtractingPlaylistSongs(songs, tracks) {
                tracks.items.forEach(
                    function(item) {
                        var track = item.track;
                        var id = track.id;
                        var name = track.name;
                        var artist = track.artists[0].name;
                        var uri = track.uri;
                        songs.push(new Song(id, name, artist, uri));
                    }
                );
                if (tracks.next == null) // All songs extracted
                    completeShuffleAndQueue(songs);
                else { // There are more
                    $.get(tracks.next, null, function(response, status) {
                        continueExtractingPlaylistSongs(songs, response);
                    });
                }
            }

            function completeShuffleAndQueue(songs) {
                // Shuffle the songs
                for (var i = songs.length - 1; i >= 1; i--) {
                    var r = randomInt(i);
                    var temp = songs[r];
                    songs[r] = songs[i];
                    songs[i] = temp;
                }

                // Queue up first song
                $.post(
                    `https://api.spotify.com/v1/me/player/queue?uri=${songs[0].uri}`,
                    null,
                    displaySongAndQueueNext(songs, 0)
                );
            }

            function randomInt(max) {
                return Math.floor(Math.random() * max);
            }

            function displaySongAndQueueNext(songs, index) {
                return function(response, status, xhr) {
                    if (status == "nocontent") { // If response is successful
                        // Output song
                        var li = $("<li></li>")
                            .text(`${songs[index].artist} - ${songs[index].name}`);
                        $("#shuffled_list").append(li);

                        index++; // Increment index

                        if (index < songs.length) { // If songs remain...
                            // ...queue up next song
                            $.post(
                                `https://api.spotify.com/v1/me/player/queue?uri=${songs[index].uri}`,
                                null,
                                displaySongAndQueueNext(songs, index)
                            );
                        }
                    }
                };
            }
        </script>
    </head>
    <body onload=initialLoad()>
        <div id="main">
            <div id="pre_auth">
                <p><a id="auth_link">Authorize with Spotify</a></p>
                <p>Warning: Javascript must be supported and enabled for this site to function at all.</p>
            </div>
            <div id="post_auth">
                <p>Authorization successful!<br />Loading playlists...</p>
            </div>
            <div id="playlist_screen">
                <p>
                    <label>Select a playlist</label>
                    <select id="playlist_select" name="playlist_select">
                    </select>
                    <br />
                    <input type="button" value="Shuffle and Queue" onclick="startShuffleAndQueue()"/>
                    <br /><br />
                    <p>
                        Shuffled Results:
                        <ol id="shuffled_list">
                        </ol>
                    </p>
                </p>
            </div>
            <div id="failed_auth">
                <p>Authorization failed!</p>
                <p>Error: <span id="error"></span></p>
            </div>
        </div>
    </body>
</html>