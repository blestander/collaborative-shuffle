<html>
    <head>
        <title>Spotify Collaborative Shuffle</title>
        <style>
            div#pre_auth {
                display:block
            }
            div {
                display:none
            }
        </style>
        <script>
            const CLIENT_ID = "5ac550d329b64aba9bea1ee3a2dd3969";
            const SCOPE = "playlist-read-collaborative playlist-read-private user-modify-playback-state";
            var token;

            function Song(id, name, artist, uri) {
                this.id = id;
                this.name = name;
                this.artist = artist;
                this.uri = uri;
            }

            function initialLoad() {
                var url = window.location.href; // Obtains page url
                var hashFragment = url.match(/\#.*$/); // Parses out hash fragment
                if (hashFragment == null) { // No hash fragment; need to to authorization
                    var authURL = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${url}&scope=${SCOPE}`;
                    document.getElementById("auth_link").href = authURL;
                } else { // Hash fragment present; proceed onward
                    var queryString = hashFragment[0].replace("#", "?") // Convert hash fragment to query string

                    document.getElementById("pre_auth").style.display = "none"; // Hide pre-authorization screen

                    // Convert query string into searchable form
                    var query = new URLSearchParams(queryString);

                    if (query.has("access_token")) { // Authorization success
                        document.getElementById("post_auth").style.display = "block"; // Make post-auth screen visible
                        token = query.get("access_token"); // Store token for future use

                        // Request list of playlists from Spotify
                        var request = new XMLHttpRequest();
                        request.open("GET", "https://api.spotify.com/v1/me/playlists/");
                        request.onreadystatechange = displayPlaylists(request);
                        request.setRequestHeader("Authorization", `Bearer ${token}`)
                        request.send();
                        console.log("Test message: playlist request")
                    } else { // Authorization failure
                        document.getElementById("failed_auth").style.display = "block"; // Make failure screen visible
                        document.getElementById("error").innerText = query.get("error")
                    }
                }
            }
        
            function displayPlaylists(request) {
                return function() {
                    if (request.readyState == XMLHttpRequest.DONE) { // Response from Spotify received
                        if (request.status == 200 || request.status == 304) { // Response is OK or cached
                            document.getElementById("post_auth").style.display = "none"; // Hide post-auth screen
                            document.getElementById("playlist_screen").style.display = "block"; // Show playlist select screen

                            var response = JSON.parse(request.response); // Full response
                            var selector = document.getElementById("playlist_select"); // Obtain playlist dropdown.
                            var playlists = response.items; // Obtain list of playlists from response
                            // For each playlist, create an option in the drop down.
                            playlists.forEach(function(playlist, index) {
                                var option = document.createElement("option");
                                option.value = playlist.id;
                                option.innerText = playlist.name;
                                selector.appendChild(option);
                            });

                            // If there are more playlists, obtain them.
                            if (response.next != null) {
                                var newRequest = new XMLHttpRequest();
                                newRequest.open("GET", response.next);
                                newRequest.onreadystatechange = displayPlaylists(newRequest);
                                newRequest.setRequestHeader("Authorization", `Bearer ${token}`);
                                request.send();
                            }
                        }
                    }
                };
            }

            function shuffleAndQueue() {
                // Obtain selected playlist ID
                var id = document.getElementById("playlist_select").value;
                
                // Retrieve songs
                var request = new XMLHttpRequest();
                request.open("GET", `https://api.spotify.com/v1/playlists/${id}`)
                request.onreadystatechange = shuffleAndQueue2(request);
                request.setRequestHeader("Authorization", `Bearer ${token}`);
                request.send();
            }

            function shuffleAndQueue2(request) {
                return function() {
                    if (request.readyState == XMLHttpRequest.DONE) // If response has been received
                        if (request.status == 200 || request.status == 304) { // If response is OK or cached
                            var response = JSON.parse(request.response);
                            var songs = new Array();
                            extractPlaylistSongs(songs, response.tracks);
                        }
                };
            }

            function extractPlaylistSongs(songs, tracks) {
                tracks.items.forEach(
                    function(item) {
                        var track = item.track;
                        var id = track.id;
                        var name = track.name;
                        var artist = track.artists[0].name;
                        var uri = track.uri;
                        songs.push(new Song(id, name, artist, uri));
                    }
                );
                if (tracks.next == null) // All songs extracted
                    shuffleAndQueue3(songs);
                else { // There are more
                    var request = new XMLHttpRequest();
                    request.open("GET", tracks.next);
                    request.onreadystatechange = function() {
                        if (request.readyState == XMLHttpRequest.DONE) // If response has been received
                            if (request.status == 200 || request.status == 304) { // If response is OK or cached
                                var response = JSON.parse(request.response);
                                extractPlaylistSongs(songs, response);
                        }
                    };
                    request.setRequestHeader("Authorization", `Bearer ${token}`);
                    request.send();
                }
            }

            function shuffleAndQueue3(songs) {
                // Shuffle the songs
                for (var i = songs.length - 1; i >= 1; i--) {
                    var r = randomInt(i);
                    var temp = songs[r];
                    songs[r] = songs[i];
                    songs[i] = temp;
                }

                // Queue up first song
                var request = new XMLHttpRequest();
                request.open("POST", `https://api.spotify.com/v1/me/player/queue?uri=${songs[0].uri}`);
                request.onreadystatechange = waitAndQueueSong(songs, request, 0);
                request.setRequestHeader("Authorization", `Bearer ${token}`);
                request.send();
            }

            function randomInt(max) {
                return Math.floor(Math.random() * max);
            }

            function waitAndQueueSong(songs, request, index) {
                return function() {
                    if (request.readyState == XMLHttpRequest.DONE) // If response has been received
                        if (request.status == 204) { // If response is successful
                            index++;

                            if (index == songs.length) // If done...
                                outputSongs(songs); // ...output songs and be done
                            else { // Otherwise...
                                // ...queue up next song
                                var newRequest = new XMLHttpRequest();
                                request.open("POST", `https://api.spotify.com/v1/me/player/queue?uri=${songs[index].uri}`);
                                request.onreadystatechange = waitAndQueueSong(songs, request, index);
                                request.setRequestHeader("Authorization", `Bearer ${token}`);
                                request.send();
                            }
                        }
                };
            }

            function outputSongs(songs) {
                var output = document.getElementById("shuffled_list");
                songs.forEach(function(song) {
                    var li = document.createElement("li");
                    li.innerText = `${song.artist} - ${song.name}`;
                    output.appendChild(li);
                });
            }
        </script>
    </head>
    <body onload=initialLoad()>
        <div id="pre_auth">
            <p><a id="auth_link">Authorize with Spotify</a></p>
            <p>Warning: Javascript must be supported and enabled for this site to function at all.</p>
        </div>
        <div id="post_auth">
            <p>Authorization successful!<br />Loading playlists...</p>
        </div>
        <div id="playlist_screen">
            <p>
                <label>Select a playlist</label>
                <select id="playlist_select" name="playlist_select">
                </select>
                <br />
                <input type="button" value="Shuffle and Queue" onclick="shuffleAndQueue()"/>
                <br /><br />
                <p>
                    Shuffled Results:
                    <ol id="shuffled_list">
                    </ol>
                </p>
            </p>
        </div>
        <div id="failed_auth">
            <p>Authorization failed!</p>
            <p>Error: <span id="error"></span></p>
        </div>
    </body>
</html>